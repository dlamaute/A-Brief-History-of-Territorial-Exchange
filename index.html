<!DOCTYPE html>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<link rel="stylesheet" 	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://d3js.org/d3.v4.min.js"></script>

<div class="header">
	<h1>A Brief History of Territorial Exchange</h1>
	<p id="yrs"> - </p>
	<p id="heading"> Search by Country: </p>
	<div id="countries"></div>
</div>

<div id="story-buttons" class="btn-group" role="group" aria-label="people">
		<button type="button" id="button1" class="btn btn-default" onClick="updateData(false);">Land</button>
		<button type="button" id="button2" class="btn btn-default" onClick="updateData(true);">People</button>
</div>

<div id="other-story-buttons" class="btn-group" role="group" aria-label="people">
	<button type="button" id="button3" class="btn btn-default" onClick="updateGains(0);">Gains</button>
	<button type="button" id="button4" class="btn btn-default" onClick="updateGains(1);">Losses</button>
	<button type="button" id="button5" class="btn btn-default" onClick="updateGains(2);">Net</button>
</div>


<div class="right-buttons" id="exchanges"></div>

<style>

.header{
	position: absolute;
	left: 2%;
	width:550px;
	height:0px;
	text-align: center;
	top: 5%;
	z-index: 2;
}

h1 {
	font-size: 50px;
	z-index: 2;
}

#heading{
	padding-top: 5%;
	font-size: 25px;
}

#yrs{
	padding-top: 5%;
	font-size: 25px;
}

#story-buttons {
  position: absolute;
  left: 41%;
  top: 25px;
	z-index: 2;
}

#other-story-buttons {
  position: absolute;
  left: 41%;
  top: 75px;
	z-index: 2;
}

.clicked {
	background-color: lightgray;
}

.right-buttons {
  position: absolute;
  left: 80%;
  top: 25px;
	z-index: 2;
	text-align: center;
}

#countries {
	padding-top: 2%;
}

#country {
	text-align: center;
	border-radius: 12px;
	width: 250px;
}

#d3-dropdown {
	text-align: center;
	border-radius: 12px;
	width: 150px;
}
  
svg {
 display: inline-block;
 font: 16px"Avenir";
 left: 40%;
 position: relative;
 z-index: 1;
}
  
  div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: 60px;					
    height: 45px;					
    padding: 2px;				
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
  }
  
  .area {
  fill: steelblue;
  clip-path: url(#clip);
}


</style>

<svg width="750" height="700" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>

<script>
	var svg = d3.select("svg"),
	margin = {top: 20, right: 20, bottom: 110, left: 40},
    margin2 = {top: 600, right: 20, bottom: 30, left: 40},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom,
    height2 = +svg.attr("height") - margin2.top - margin2.bottom;

var lower = 1815;
var upper = 2016;
var isPeople = false;
var exchangeType = null;
var gains = 0;

var countries = d3.csv("wrangle.csv", function(error, data) {
			var select = d3.select("#countries")
				.append("div")
				.append("select")
				.attr("class", "custom-select")
				.attr("id", "country")
	
			select.selectAll("option")
				.data(d3.map(data, function(d){return d["gainer"];}).keys())
				.enter()
					.append("option")
					.text(function (d) { return d; });
		});

		var exchanges = d3.csv("wrangle.csv", function(error, data) {
			var select = d3.select("#exchanges")
				.append("div")
				.append("select")
				.on('change',onchange)
				.attr("class", "custom-select")
				.attr("id", "country")
	
			select.selectAll("option")
				.data(d3.map(data, function(d){return d["procedure"];}).keys())
				.enter()
					.append("option")
					.text(function (d) { return d; });
		});

function onchange() {
		var selected = d3.select(this).property("value");
		exchangeType = selected=="All" ? null : selected;
		updateBubble(lower, upper, isPeople, exchangeType, gains);
		updateTimeline(exchangeType);
};

function updateYearsBanner(lower, upper) {
	var select = d3.select("#yrs")
					.text("" + lower + " - " + upper);
}

updateYearsBanner(lower, upper);

function updateData(value) {
	if (value == false) {
		d3.select("#button1").classed("clicked", true);
		d3.select("#button2").classed("clicked", false);
	}
	else {
		d3.select("#button1").classed("clicked", false);
		d3.select("#button2").classed("clicked", true);
	}
	isPeople = value;
	if (gains == 0 || value == gains) {
		updateBubble(lower, upper, isPeople, exchangeType, gains);	
	}
	else {
		updateNetBubble(lower, upper, isPeople, exchangeType);	
	}
}

function updateGains(value) {
	if (value == 0) {
		d3.select("#button3").classed("clicked", true);
		d3.select("#button4").classed("clicked", false);
		d3.select("#button5").classed("clicked", false);
	}
	else if (value == 1) {
		d3.select("#button3").classed("clicked", false);
		d3.select("#button4").classed("clicked", true);
		d3.select("#button5").classed("clicked", false);
	}
	else {
		d3.select("#button3").classed("clicked", false);
		d3.select("#button4").classed("clicked", false);
		d3.select("#button5").classed("clicked", true);
	}
	gains = value;
	if (value == 0 || value == 1) {
		updateBubble(lower, upper, isPeople, exchangeType, gains);	
	}
	else {
		updateNetBubble(lower, upper, isPeople, exchangeType);	
	}
}

d3.select("#people").on("click", function() {
					isPeople = true;
					updateBubble(lower, upper, isPeople, exchangeType, gains);				
				});

d3.select("#land").on("click", function() {
					isPeople = false;
					updateBubble(lower, upper, isPeople, exchangeType, gains);
					;});

var pack = d3.pack()
    .size([width-150, height])
    .padding(1.5);
	
// INITIALIZATION
updateTimeline("All");
d3.select("#button1").classed("clicked", true);
d3.select("#button3").classed("clicked", true);
	
function updateTimeline(exchangeType) {

	d3.csv("wrangle.csv", 
		function(d) {
			d.exchange = +d["procedure"];
			d.land = +d["area"];
			d.people = +d["pop"];
			d.year = d["year"];
			d.count = d["count"];

			return d;
		}, 
		function(error, data) {
			if (error) throw error;
			
			svg.selectAll(".focus").remove();
			svg.selectAll(".context").remove();
			
			var x = d3.scaleLinear().range([0, width]),
				y2 = d3.scaleLinear().range([height2, 0]);
				
			var yTicks = 6;
			if (exchangeType=="Annexation") {
				yTicks = 3;
			}
			if (exchangeType=="Conquest") {
				yTicks = 4;
			}
			if (exchangeType=="Unification") {
				yTicks = 6;
			}

			var xAxis = d3.axisBottom(x).ticks(20).tickFormat(d3.format(".4")),
				yAxis2 = d3.axisLeft(y2).ticks(yTicks);

			var brush = d3.brushX()
				.extent([[0, 0], [width, height2]])
				.on("brush end", brushed);
				
			var area2 = d3.area()
				.curve(d3.curveStep)
				.x(function(d) { return x(d["year"]/*.year*/); })
				.y0(height2)
				.y1(function(d) { return y2(d["count"]/*.count*/); });
				
			var focus = svg.append("g")
				.attr("class", "focus")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
			var context = svg.append("g")
				.attr("class", "context")
				.attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

			
			data4timeline = []
			for (i=1816; i<=2018; i++) {
				year_string = "" + i;
				data4timeline.push( {"year": year_string, "count": 0, "pop": 0, "area": 0} );
			}
			
			for (i=0; i<data.length; i++) {
				if (exchangeType=="All" || exchangeType==null || data[i]["procedure"]==exchangeType) {
					thisYear = data[i]["year"]
					for (j=1816; j<=2018; j++) {
						if (thisYear == j) {
							data4timeline[j-1816]["count"] += 1;
						}
					}
				}
			}
			
			// Set the timeline line graph domain
			x.domain(d3.extent(data4timeline, function(d) { return d["year"]/*.year*/; }));
			y2.domain([0, d3.max(data4timeline, function(d) { return d["count"]/*.count*/; })]);

			// Draw the y-axis
			focus.append("g")
				 .attr("class", "axis axis--y")
				 .attr("transform", "translate(0," + (height + 10) + ")")
				 .call(yAxis2);
			
			
			// Draw the line graph given the data
			context.append("path")
				  .datum(data4timeline)
				  .attr("class", "area")
				  .attr("d", area2);

			// Draw the x-axis
			context.append("g")
				  .attr("class", "axis axis--x")
				  .attr("transform", "translate(0," + height2 + ")")
				  .call(xAxis);

			// Draw the brush
			context.append("g")
				  .attr("class", "brush")
				  .call(brush)
				  .call(brush.move, x.range());
	  
	});

}

function brushed() {

	var s = d3.event.selection || x.range();
	var min_year = Math.ceil(s[0]/3.41584 + 1815);		// Gets the minimum
	var max_year = Math.floor(s[1]/3.41584 + 1815);		// Gets the maximum
	var range_years = [min_year, max_year]; 
	
	lower = min_year
	upper = max_year
	
	updateYearsBanner(lower, upper);
	
	if (gains != 2) {
		updateBubble(lower, upper, isPeople, exchangeType, gains);
	}
	else {
		updateNetBubble(lower, upper, isPeople, exchangeType);
	}
}

function updateBubble(lower_bound, upper_bound, type, exchange, gains) {

	d3.csv("wrangle.csv", 
					function(d) {
						d.exchange = d["procedure"];
						d.land = +d["area"];
						d.people = +d["pop"];
						d.year = d["year"];
						d.gainer = d["gainer"];
						d.loser = d["loser"];

						return d;
					}, 
					function(error, data) {
						if (error) throw error;

						svg.selectAll(".node").remove();

						var color = d3.scaleOrdinal()
											.domain(data.map(function(d){ return d.year; }))
											.range(['#fbb4ae','#b3cde3','#ccebc5','#decbe4','#fed9a6', '#ffe9a8','#b9bfe3','#fddaec','#cccccc']);

							data2 = data.filter(function(d) {
								if (exchange) {
									return d.year >= lower_bound && d.year <= upper_bound && d.exchange
									&& d.exchange == exchange;
								}
								else {
									return d.year >= lower_bound && d.year <= upper_bound;
								}
							});
							
							var variable = gains == 0 ? "gainer" : "loser";

							var data3 = [];
							for (i=0; i < data2.length; i++) {
								//console.log(data2[i]);
								var alreadyPresent = false;
								entity2check = data2[i][variable];
								index2save = null;
								for (j=0; j < data3.length; j++) {
									if (data3[j][variable] == entity2check) {
										index2save = j;
										alreadyPresent = true;
									}
								}
								if (alreadyPresent == true) {
									data3[index2save]["land"] += data2[i]["land"];
									data3[index2save]["people"] += data2[i]["people"];
								}
								else {
									data3.push(data2[i]);
								}
							}
							
							var root = type == true ? d3.hierarchy({children: data3})
											.sum(function(d) { return d.people; }) :
											d3.hierarchy({children: data3})
											.sum(function(d) { return d.land; });

							var node = svg.selectAll(".node")
											.data(pack(root).leaves())
											.enter().append("g")
											.attr("class", "node")
											.attr("transform", function(d) { return "translate(" + (d.x + 125) + "," + d.y + ")"; });


							node.append("circle")
									.attr("id", function(d) { return d.id; })
									.attr("r", function(d) { return d.r; })
									.style("fill", function(d) { return color(d.data.year); });


							node.append("text")
									.attr("font-size", function(d) { return 0.25*d.r + "px"; })
									.text(function(d) {
										return gains == 0 ? d.data.gainer : d.data.loser;
									});
					});
}

function updateNetBubble(lower_bound, upper_bound, type, exchange) {

d3.csv("wrangle.csv", 
				function(d) {
					d.exchange = d["procedure"];
					d.land = +d["area"];
					d.people = +d["pop"];
					d.year = d["year"];
					d.gainer = d["gainer"];
					d.loser = d["loser"];

					return d;
				}, 
				function(error, data) {
					if (error) throw error;

					svg.selectAll(".node").remove();

						data2 = data.filter(function(d) {
							if (exchange) {
								return d.year >= lower_bound && d.year <= upper_bound && d.exchange
								&& d.exchange == exchange;
							}
							else {
								return d.year >= lower_bound && d.year <= upper_bound;
							}
						});
						
						var data3 = [];
						for (i=0; i < data2.length; i++) {
							//console.log(data2[i]);
							var alreadyPresentGain = false;
							var alreadyPresentLoss = false;
							entity2check = data2[i]["gainer"];
							otherentity2check = data2[i]["loser"];
							index2save = null;
							index2save1 = null;
							for (j=0; j < data3.length; j++) {
								if (data3[j]["entity"] == entity2check) {
									index2save = j;
									alreadyPresentGain = true;
								}
								if (data3[j]["entity"] == otherentity2check) {
									index2save1 = j;
									alreadyPresentLoss = true;	
								}
							}
							if (alreadyPresentGain == false && alreadyPresentLoss == false) {
								data2[i]["entity"] = data2[i]["gainer"];
								data3.push(data2[i]);
								newdata = {};
								newdata["exchange"] = -1 * data2[i]["exchange"];
								newdata["land"] = -1 * data2[i]["land"];
								newdata["people"] = -1 * data2[i]["people"];
								newdata["entity"] = data2[i]["loser"];
								data3.push(newdata);
							}
							else {
								if (alreadyPresentGain == true ) {
									data3[index2save]["land"] += data2[i]["land"];
									data3[index2save]["people"] += data2[i]["people"];
								}
								else {
									data3[index2save1]["land"] -= data2[i]["land"];
									data3[index2save1]["people"] -= data2[i]["people"];
								}
							}
						};

						for (i=0; i < data3.length; i++) {
							data3[i]["peopleLoss"] = data3[i]["people"] >= 0 ? "false" : "true";
							data3[i]["landLoss"] = data3[i]["land"] >= 0 ? "false" : "true";
						}
						
						var root = type == true ? d3.hierarchy({children: data3})
										.sum(function(d) { return Math.abs(d.people); }) :
										d3.hierarchy({children: data3})
										.sum(function(d) { return Math.abs(d.land); });

						var node = svg.selectAll(".node")
										.data(pack(root).leaves())
										.enter().append("g")
										.attr("class", "node")
										.attr("transform", function(d) { return "translate(" + (d.x + 125) + "," + d.y + ")"; });


						node.append("circle")
								.attr("id", function(d) { return d.id; })
								.attr("r", function(d) { return d.r; })
								.style("fill", function(d) { 
									if (type == true) {
										return d.data.peopleLoss == "false" ? '#b3cde3' : '#fbb4ae';
									}
									else {
										return d.data.landLoss == "false" ? '#b3cde3' : '#fbb4ae';
									} });


						node.append("text")
								.attr("font-size", function(d) { return 0.25*d.r + "px"; })
								.text(function(d) {
									return d.data.entity;
								});
				});
}

</script>


</html>